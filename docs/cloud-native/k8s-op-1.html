<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Kubernetes operation and maintenance records (1) - English version of the website https://www.backendcloud.cn/</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../style.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">1.</strong> Catalog: Cloud Native</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cloud-native/k3s-install.html"><strong aria-hidden="true">1.1.</strong> k3s deployment and simple use and Longhorn deployment and use</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-op-5.html"><strong aria-hidden="true">1.2.</strong> Kubernetes operation and maintenance records (5)</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-op-4.html"><strong aria-hidden="true">1.3.</strong> Kubernetes operation and maintenance records (4)</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-op-3.html"><strong aria-hidden="true">1.4.</strong> Kubernetes operation and maintenance records (3)</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-op-2.html"><strong aria-hidden="true">1.5.</strong> Kubernetes operation and maintenance records (2)</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-op-1.html" class="active"><strong aria-hidden="true">1.6.</strong> Kubernetes operation and maintenance records (1)</a></li><li class="chapter-item expanded "><a href="../cloud-native/docker-storage-driver.html"><strong aria-hidden="true">1.7.</strong> Docker Storage Driver - Overlay2</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-service.html"><strong aria-hidden="true">1.8.</strong> Kubernetes Service</a></li><li class="chapter-item expanded "><a href="../cloud-native/cilium-replace-kube-proxy.html"><strong aria-hidden="true">1.9.</strong> Cilium completely replaces kube-proxy</a></li><li class="chapter-item expanded "><a href="../cloud-native/cilium-install.html"><strong aria-hidden="true">1.10.</strong> Cilium install</a></li><li class="chapter-item expanded "><a href="../cloud-native/kubevirtci-for-chinanet.html"><strong aria-hidden="true">1.11.</strong> KubeVirt CI adapts to China's network</a></li><li class="chapter-item expanded "><a href="../cloud-native/web-terminal.html"><strong aria-hidden="true">1.12.</strong> Web Terminal</a></li><li class="chapter-item expanded "><a href="../cloud-native/deploy-kubevirt.html"><strong aria-hidden="true">1.13.</strong> Deploy Kubernetes + KubeVirt and the basic use of KubeVirt</a></li><li class="chapter-item expanded "><a href="../cloud-native/docker-java-demo.html"><strong aria-hidden="true">1.14.</strong> docker hello-world project</a></li><li class="chapter-item expanded "><a href="../cloud-native/deploy-cinder-csi-plugin.html"><strong aria-hidden="true">1.15.</strong> Several problems encountered in deploying cinder-csi-plugin</a></li><li class="chapter-item expanded "><a href="../cloud-native/go1.18-workspace.html"><strong aria-hidden="true">1.16.</strong> New in Go 1.18 - Workspaces</a></li><li class="chapter-item expanded "><a href="../cloud-native/spring-boot-async-demo.html"><strong aria-hidden="true">1.17.</strong> spring-boot asynchronous example</a></li><li class="chapter-item expanded "><a href="../cloud-native/plg.html"><strong aria-hidden="true">1.18.</strong> PLG implements Kubernetes Pod log collection and display</a></li><li class="chapter-item expanded "><a href="../cloud-native/fluentd.html"><strong aria-hidden="true">1.19.</strong> Fluentd implements Kubernetes Pod log collection</a></li><li class="chapter-item expanded "><a href="../cloud-native/java-dev-memo-1.html"><strong aria-hidden="true">1.20.</strong> Little records in Java project development (1)</a></li><li class="chapter-item expanded "><a href="../cloud-native/jdk-bug.html"><strong aria-hidden="true">1.21.</strong> JDK bug - Encrypt Private Key failed unrecognized algorithm name PBEWithSHA1AndDESede</a></li><li class="chapter-item expanded "><a href="../cloud-native/tenant-cmp.html"><strong aria-hidden="true">1.22.</strong> Implementation of the function of creating resource pool tenants on the cloud management platform</a></li><li class="chapter-item expanded "><a href="../cloud-native/test-service-performance-2.html"><strong aria-hidden="true">1.23.</strong> iperf3 tests the four-layer performance of Kubernetes Service (Part 2)</a></li><li class="chapter-item expanded "><a href="../cloud-native/test-service-performance-1.html"><strong aria-hidden="true">1.24.</strong> iperf3 tests the four-layer performance of Kubernetes Service (Part 1)</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-cmd.html"><strong aria-hidden="true">1.25.</strong> k8s common command</a></li><li class="chapter-item expanded "><a href="../cloud-native/cpu-binding.html"><strong aria-hidden="true">1.26.</strong> k8s supports container core binding</a></li><li class="chapter-item expanded "><a href="../cloud-native/capability.html"><strong aria-hidden="true">1.27.</strong> k8s supports Capability mechanism</a></li><li class="chapter-item expanded "><a href="../cloud-native/oom.html"><strong aria-hidden="true">1.28.</strong> k8s OOMkilled container exceeding memory limit</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">2.</strong> Catalog: Openstack</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../openstack/deploy-openstack-stein.html"><strong aria-hidden="true">2.1.</strong> Problems encountered in Openstack Stein deployment</a></li><li class="chapter-item expanded "><a href="../openstack/sriov2ovs.html"><strong aria-hidden="true">2.2.</strong> sriov computing node to ovs computing node script</a></li><li class="chapter-item expanded "><a href="../openstack/placement.html"><strong aria-hidden="true">2.3.</strong> Openstack Placement</a></li><li class="chapter-item expanded "><a href="../openstack/power-arch.html"><strong aria-hidden="true">2.4.</strong> POWER architecture server as computing node</a></li><li class="chapter-item expanded "><a href="../openstack/sriov.html"><strong aria-hidden="true">2.5.</strong> OpenStack practices SR-IOV computing nodes</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-5.html"><strong aria-hidden="true">2.6.</strong> Openstack operation and maintenance records (5)</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-4.html"><strong aria-hidden="true">2.7.</strong> Openstack operation and maintenance records (4)</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-3.html"><strong aria-hidden="true">2.8.</strong> Openstack operation and maintenance records (3)</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-2.html"><strong aria-hidden="true">2.9.</strong> Openstack operation and maintenance records (2)</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-1.html"><strong aria-hidden="true">2.10.</strong> Openstack operation and maintenance records (1)</a></li><li class="chapter-item expanded "><a href="../openstack/novnc-problem.html"><strong aria-hidden="true">2.11.</strong> OpenStack Pike dashboard noVNC cannot be accessed problem</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-local-yum.html"><strong aria-hidden="true">2.12.</strong> Openstack Pike local yum source construction</a></li><li class="chapter-item expanded "><a href="../openstack/cpu-binding.html"><strong aria-hidden="true">2.13.</strong> CPU binding</a></li><li class="chapter-item expanded "><a href="../openstack/resize-fail.html"><strong aria-hidden="true">2.14.</strong> Investigation of the cause of resize failure</a></li><li class="chapter-item expanded "><a href="../openstack/mount-cloud-disk.html"><strong aria-hidden="true">2.15.</strong> Mount cloud disk</a></li><li class="chapter-item expanded "><a href="../openstack/ocata-nova-evacuate-bug.html"><strong aria-hidden="true">2.16.</strong> Ocata nova evacuate bug</a></li><li class="chapter-item expanded "><a href="../openstack/compute-node-ha.html"><strong aria-hidden="true">2.17.</strong> compute node ha mainstream open source implementation</a></li><li class="chapter-item expanded "><a href="../openstack/collectd-influxdb.html"><strong aria-hidden="true">2.18.</strong> Deployment and usage of Collectd and InfluxDB</a></li><li class="chapter-item expanded "><a href="../openstack/live-migration-local.html"><strong aria-hidden="true">2.19.</strong> Live Migration on Local Storage</a></li><li class="chapter-item expanded "><a href="../openstack/fast-evacuation.html"><strong aria-hidden="true">2.20.</strong> Add fast evacuation function to VM HA procedure</a></li><li class="chapter-item expanded "><a href="../openstack/vm-activation-failure.html"><strong aria-hidden="true">2.21.</strong> Windows virtual machine activation failure problem</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">3.</strong> Catalog: Point of view</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../point-of-view/huawei-and-operators.html"><strong aria-hidden="true">3.1.</strong> Huawei and telecom operators</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">4.</strong> Open source small project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../open-source-small-project/firewall-tool.html"><strong aria-hidden="true">4.1.</strong> Open source a node.js firewall tool</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">5.</strong> Catalog: Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tools/github-action.html"><strong aria-hidden="true">5.1.</strong> Github Action Supplementary Introduction</a></li><li class="chapter-item expanded "><a href="../tools/blog-cicd.html"><strong aria-hidden="true">5.2.</strong> Github Action Upgrade backend cloud website CICD process</a></li><li class="chapter-item expanded "><a href="../tools/github-action-demo.html"><strong aria-hidden="true">5.3.</strong> Try the Github Action CI/CD process (create a React project and package it for deployment)</a></li><li class="chapter-item expanded "><a href="../tools/notion-widget.html"><strong aria-hidden="true">5.4.</strong> Notion's page insert widget Widget</a></li><li class="chapter-item expanded "><a href="../tools/git-dir.html"><strong aria-hidden="true">5.5.</strong> Internal structure of .git directory</a></li><li class="chapter-item expanded "><a href="../tools/xshell-skill.html"><strong aria-hidden="true">5.6.</strong> Some Skills of using xshell tools</a></li><li class="chapter-item expanded "><a href="../tools/gerrit-install.html"><strong aria-hidden="true">5.7.</strong> gerrit install</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">English version of the website https://www.backendcloud.cn/</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <p>release time :2022-09-13 18:14</p>
<h1 id="problem-old-applications-cannot-be-accessed-through-kubectl-exec-and-new-applications-cannot-be-created"><a class="header" href="#problem-old-applications-cannot-be-accessed-through-kubectl-exec-and-new-applications-cannot-be-created">Problem: Old applications cannot be accessed through kubectl exec, and new applications cannot be created</a></h1>
<p>Ssh into the cluster node, telnet the local kubelete service port 10250, yes.</p>
<p>telnet port 10250 of other nodes from this machine fails.</p>
<p>The cluster has made a network policy. The 10250 port policy needs to be released.</p>
<p>In the test environment, if the node where the cluster is located is a vm, you can turn off port-security through Openstack: neutron port-update port-id-zzzzz –port-security_enabled=False</p>
<h1 id="issue-modify-pod-cidr-range-cni-calico"><a class="header" href="#issue-modify-pod-cidr-range-cni-calico">Issue: Modify pod-cidr-range (CNI: calico)</a></h1>
<ol>
<li>
<p>Install calicoctl as a Kubernetes pod</p>
<h1 id="kubectl-apply--f-httpsdocsprojectcalicoorgmanifestscalicoctlyaml"><a class="header" href="#kubectl-apply--f-httpsdocsprojectcalicoorgmanifestscalicoctlyaml">kubectl apply -f https://docs.projectcalico.org/manifests/calicoctl.yaml</a></h1>
<h1 id="alias-calicoctlkubectl-exec--i--n-kube-system-calicoctl----calicoctl"><a class="header" href="#alias-calicoctlkubectl-exec--i--n-kube-system-calicoctl----calicoctl">alias calicoctl=&quot;kubectl exec -i -n kube-system calicoctl -- /calicoctl &quot;</a></h1>
</li>
<li>
<p>Add an IP pool</p>
<p>calicoctl create -f -&lt;&lt;EOF
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
name: new-pool
spec:
cidr: 10.0.0.0/8
ipipMode: Always
natOutgoing: true
EOF</p>
</li>
</ol>
<p>calicoctl get ippool -o wide can see one more line</p>
<ol start="3">
<li>Disable old IP pool</li>
</ol>
<p>calicoctl get ippool -o yaml &gt; pool.yaml</p>
<p>vim pool.yaml , modify or add:disabled: true</p>
<pre><code>apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
name: default-ipv4-ippool
spec:
cidr: 192.168.0.0/16
ipipMode: Always
natOutgoing: true
disabled: true
</code></pre>
<p>calicoctl apply -f pool.yaml</p>
<ol start="4">
<li>
<p>Modify the podCIDR of all nodes</p>
<p>$ kubectl get no kubeadm-0 -o yaml &gt; file.yaml; sed -i &quot;s~192.168.0.0/24~10.0.0.0/16~&quot; file.yaml; kubectl delete no kubeadm-0 &amp;&amp; kubectl create -f file.yaml
$ kubectl get no kubeadm-1 -o yaml &gt; file.yaml; sed -i &quot;s~192.168.1.0/24~10.1.0.0/16~&quot; file.yaml; kubectl delete no kubeadm-1 &amp;&amp; kubectl create -f file.yaml
$ kubectl get no kubeadm-2 -o yaml &gt; file.yaml; sed -i &quot;s~192.168.2.0/24~10.2.0.0/16~&quot; file.yaml; kubectl delete no kubeadm-2 &amp;&amp; kubectl create -f file.yaml </p>
</li>
<li>
<p>Modify kubeadm-config and kube-proxy ConfigMap and kube-controller-manager.yaml</p>
</li>
</ol>
<p>kubectl -n kube-system edit cm kubeadm-config</p>
<p>kubectl -n kube-system edit cm kube-proxy</p>
<p>vim /etc/kubernetes/manifests/kube-controller-manager.yaml</p>
<p>Modify the content of –cluster-cidr=xxx</p>
<ol start="6">
<li>Delete existing workloads using IPs from the disabled pool. (For example: during cluster deployment, the first coredns to use the calico ip pool after the calico service is normal)</li>
</ol>
<p>kubectl delete pod -n kube-system coredns-5495dd7c88-b2zcs</p>
<p>Use calicoctl get wep --all-namespaces to check whether the newly generated coredns pod uses the new calico ip pool ip.</p>
<ol start="7">
<li>Delete old IP pool</li>
</ol>
<p>calicoctl delete pool default-ipv4-ippool</p>
<h1 id="problem-failed-to-mount-api-filesystems-freezing"><a class="header" href="#problem-failed-to-mount-api-filesystems-freezing">Problem: Failed to mount API filesystems, freezing.</a></h1>
<pre><code>Failed to mount tmpfs at /run: Operation not permitted
Failed to mount cgroup at /sys/fs/cgroup/systemd: Operation not permitted
[!!!!!!] Failed to mount API filesystems, freezing.
# 解决方法：挂载宿主机的cgroup
docker run -it -d --name=centos7 --privileged=true -p 80:80 -v /sys/fs/cgroup:/sys/fs/cgroup:ro sevming/centos7:0.1
docker exec -it centos7 /bin/bash
systemctl status
</code></pre>
<blockquote>
<p>If you run systemd in a container, the above method is not a good way, it is recommended to use the official image: https://hub.docker.com/r/centos/systemd</p>
</blockquote>
<h1 id="problem-ingress-exposes-port-30067-through-hostport-and-cannot-be-accessed"><a class="header" href="#problem-ingress-exposes-port-30067-through-hostport-and-cannot-be-accessed">Problem: ingress exposes port 30067 through hostport and cannot be accessed</a></h1>
<p>The inspection found that the port 80 used by the ingress controller conflicts with haproxy</p>
<h1 id="problem-pods-on-different-nodes-cannot-communicate"><a class="header" href="#problem-pods-on-different-nodes-cannot-communicate">Problem: Pods on different nodes cannot communicate</a></h1>
<p>/proc/sys/net/ipv4/ip_forward is 0, and the ip forwarding function is disabled, resulting in the inability to access the pod. Change it to 1 to solve the problem.</p>
<h1 id="problem-the-service-port-can-be-accessed-on-the-node-where-the-pod-is-located-but-the-service-port-cannot-be-accessed-in-the-pod"><a class="header" href="#problem-the-service-port-can-be-accessed-on-the-node-where-the-pod-is-located-but-the-service-port-cannot-be-accessed-in-the-pod">Problem: The service port can be accessed on the node where the pod is located, but the service port cannot be accessed in the pod</a></h1>
<p>If the route in the pod is lost, restart the CNI network plug-in to restore the pod routing information.</p>
<h1 id="problem-the-v6-address-of-the-cluster-node-cannot-be-accessed-in-the-container"><a class="header" href="#problem-the-v6-address-of-the-cluster-node-cannot-be-accessed-in-the-container">Problem: The v6 address of the cluster node cannot be accessed in the container</a></h1>
<p>calicoctl edit ippool default-ipv6-ippool</p>
<p>Add parameter natOutgoing: true</p>
<h1 id="istio-ipv4-v6-dual-stack-deployment-is-ok-in-some-environments-but-has-problems-in-some-environments-from-the-client-curl-server"><a class="header" href="#istio-ipv4-v6-dual-stack-deployment-is-ok-in-some-environments-but-has-problems-in-some-environments-from-the-client-curl-server">Istio ipv4 v6 dual-stack deployment is ok in some environments, but has problems in some environments (from the client curl server)</a></h1>
<p>By grabbing the 15001 port of the sidecar, the tcp handshake on port 15001 in the problematic environment will fail, and there will be no ack response, but the tcp handshake will succeed in the ok environment, and the request will be processed normally.</p>
<p>The kernel version of the environment in question does not support iptables forwarding for ipv6. ok environment kernel support. So it can be solved by upgrading the kernel version.</p>
<p>Also try similar rules on the host, such as:</p>
<p>ip6tables -t nat -I OUTPUT -p tcp –dport 30022 -j REDIRECT –to-ports 22</p>
<p>then verify</p>
<p>ssh fd15:4ba5:5a2b:1008:20c:29ff:fe7c:bcd1 -p 30022</p>
<p>If the forwarding is correct, you can ssh, otherwise you can't.</p>
<blockquote>
<p>istio uses iptables to direct all outgoing traffic to the local 15001, and can also be tested on the host through similar configurations. All outgoing traffic to 30022 is directed to the local 22. The principle is the same as istio.</p>
</blockquote>
<h1 id="issue-certificate-handling"><a class="header" href="#issue-certificate-handling">Issue: Certificate handling</a></h1>
<pre><code># Check the certificate validity period
[root@kubevirt ~]# kubeadm certs check-expiration
[check-expiration] Reading configuration from the cluster...
[check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
W0914 16:43:35.868627   31135 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 May 25, 2023 09:01 UTC   253d                                    no      
apiserver                  May 25, 2023 09:01 UTC   253d            ca                      no      
apiserver-kubelet-client   May 25, 2023 09:01 UTC   253d            ca                      no      
controller-manager.conf    May 25, 2023 09:01 UTC   253d                                    no      
front-proxy-client         May 25, 2023 09:01 UTC   253d            front-proxy-ca          no      
scheduler.conf             May 25, 2023 09:01 UTC   253d                                    no      

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      May 22, 2032 09:01 UTC   9y              no      
front-proxy-ca          May 22, 2032 09:01 UTC   9y              no      
# Check whether the certificate is automatically renewed
[root@kubevirt ~]# kubectl get cm -o yaml -n kube-system kubeadm-config | grep RotateKubeletServerCertificate
        feature-gates: RotateKubeletServerCertificate=true,TTLAfterFinished=true,ExpandCSIVolumes=true,CSIStorageCapacity=true
        feature-gates: RotateKubeletServerCertificate=true,TTLAfterFinished=true,ExpandCSIVolumes=true,CSIStorageCapacity=true
        feature-gates: RotateKubeletServerCertificate=true,TTLAfterFinished=true,ExpandCSIVolumes=true,CSIStorageCapacity=true
[root@kubevirt ~]# kubectl get no
NAME       STATUS   ROLES                         AGE    VERSION
kubevirt   Ready    control-plane,master,worker   111d   v1.21.5
# Update the validity period of the certificate (the method below is only applicable to Kubernetes 1.21 and above)
[root@kubevirt ~]# kubeadm certs renew all
[renew] Reading configuration from the cluster...
[renew] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
W0914 16:45:30.798557   46420 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]

certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed
certificate for serving the Kubernetes API renewed
certificate for the API server to connect to kubelet renewed
certificate embedded in the kubeconfig file for the controller manager to use renewed
certificate for the front proxy client renewed
certificate embedded in the kubeconfig file for the scheduler manager to use renewed

Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.
[root@kubevirt ~]# kubeadm certs check-expiration
[check-expiration] Reading configuration from the cluster...
[check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
W0914 16:45:44.191471   48482 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Sep 14, 2023 08:45 UTC   364d                                    no      
apiserver                  Sep 14, 2023 08:45 UTC   364d            ca                      no      
apiserver-kubelet-client   Sep 14, 2023 08:45 UTC   364d            ca                      no      
controller-manager.conf    Sep 14, 2023 08:45 UTC   364d                                    no      
front-proxy-client         Sep 14, 2023 08:45 UTC   364d            front-proxy-ca          no      
scheduler.conf             Sep 14, 2023 08:45 UTC   364d                                    no      

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      May 22, 2032 09:01 UTC   9y              no      
front-proxy-ca          May 22, 2032 09:01 UTC   9y              no  

[root@kubevirt manifests]# pwd
/etc/kubernetes/manifests
[root@kubevirt manifests]# grep RotateKubeletServerCertificate *
kube-apiserver.yaml:    - --feature-gates=RotateKubeletServerCertificate=true,TTLAfterFinished=true,ExpandCSIVolumes=true,CSIStorageCapacity=true
kube-controller-manager.yaml:    - --feature-gates=RotateKubeletServerCertificate=true,TTLAfterFinished=true,ExpandCSIVolumes=true,CSIStorageCapacity=true
kube-scheduler.yaml:    - --feature-gates=RotateKubeletServerCertificate=true,TTLAfterFinished=true,ExpandCSIVolumes=true,CSIStorageCapacity=true
</code></pre>
<h1 id="problem-emerg-bind-to-0000801-failed-13-permission-denied"><a class="header" href="#problem-emerg-bind-to-0000801-failed-13-permission-denied">Problem: [emerg] bind() to 0.0.0.0:801 failed (13: Permission denied)</a></h1>
<p>kubectl logs -f pod-xxx reports an error:</p>
<p>[emerg] bind() to 0.0.0.0:801 failed (13: Permission denied)</p>
<p>Check the abnormal pod log, indicating insufficient permissions.</p>
<p>Entering the pod discovery is started by a non-root user:</p>
<pre><code>[root@centos7 ~]# kubectl exec  ingress-nginx-controller-7b768967bc-fd2hg -ningress-nginx -- id
uid=101(www-data) gid=82(www-data)
</code></pre>
<p>sysctl -a|grep unprivileged_portNo information was found, indicating that the value of this parameter is the default value of 1024 (the process number from 1 to 1023 is reserved for the root user, and the default value is 1024), so port 801 reported insufficient permissions.</p>
<p>2 countermeasures (choose 1 from 2):</p>
<ol>
<li>sysctl -w net.ipv4.ip_unprivileged_port_start=400(Through sysctl -w, the parameters can only take effect immediately (temporary effect). If you want to take effect permanently, you need to configure the parameters to /etc/sysctl.conf)</li>
<li>Containers use port 1024 or greater</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../cloud-native/k8s-op-2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../cloud-native/docker-storage-driver.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../cloud-native/k8s-op-2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../cloud-native/docker-storage-driver.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../sidebar.js"></script>


    </body>
</html>