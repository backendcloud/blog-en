<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Cilium completely replaces kube-proxy - English version of the website https://www.backendcloud.cn/</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../style.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">1.</strong> Catalog: Cloud Native</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cloud-native/k8s-service.html"><strong aria-hidden="true">1.1.</strong> Kubernetes Service</a></li><li class="chapter-item expanded "><a href="../cloud-native/cilium-replace-kube-proxy.html" class="active"><strong aria-hidden="true">1.2.</strong> Cilium completely replaces kube-proxy</a></li><li class="chapter-item expanded "><a href="../cloud-native/cilium-install.html"><strong aria-hidden="true">1.3.</strong> Cilium install</a></li><li class="chapter-item expanded "><a href="../cloud-native/kubevirtci-for-chinanet.html"><strong aria-hidden="true">1.4.</strong> KubeVirt CI adapts to China's network</a></li><li class="chapter-item expanded "><a href="../cloud-native/web-terminal.html"><strong aria-hidden="true">1.5.</strong> Web Terminal</a></li><li class="chapter-item expanded "><a href="../cloud-native/deploy-kubevirt.html"><strong aria-hidden="true">1.6.</strong> Deploy Kubernetes + KubeVirt and the basic use of KubeVirt</a></li><li class="chapter-item expanded "><a href="../cloud-native/docker-java-demo.html"><strong aria-hidden="true">1.7.</strong> docker hello-world project</a></li><li class="chapter-item expanded "><a href="../cloud-native/deploy-cinder-csi-plugin.html"><strong aria-hidden="true">1.8.</strong> Several problems encountered in deploying cinder-csi-plugin</a></li><li class="chapter-item expanded "><a href="../cloud-native/go1.18-workspace.html"><strong aria-hidden="true">1.9.</strong> New in Go 1.18 - Workspaces</a></li><li class="chapter-item expanded "><a href="../cloud-native/spring-boot-async-demo.html"><strong aria-hidden="true">1.10.</strong> spring-boot asynchronous example</a></li><li class="chapter-item expanded "><a href="../cloud-native/plg.html"><strong aria-hidden="true">1.11.</strong> PLG implements Kubernetes Pod log collection and display</a></li><li class="chapter-item expanded "><a href="../cloud-native/fluentd.html"><strong aria-hidden="true">1.12.</strong> Fluentd implements Kubernetes Pod log collection</a></li><li class="chapter-item expanded "><a href="../cloud-native/java-dev-memo-1.html"><strong aria-hidden="true">1.13.</strong> Little records in Java project development (1)</a></li><li class="chapter-item expanded "><a href="../cloud-native/jdk-bug.html"><strong aria-hidden="true">1.14.</strong> JDK bug - Encrypt Private Key failed unrecognized algorithm name PBEWithSHA1AndDESede</a></li><li class="chapter-item expanded "><a href="../cloud-native/tenant-cmp.html"><strong aria-hidden="true">1.15.</strong> Implementation of the function of creating resource pool tenants on the cloud management platform</a></li><li class="chapter-item expanded "><a href="../cloud-native/test-service-performance-2.html"><strong aria-hidden="true">1.16.</strong> iperf3 tests the four-layer performance of Kubernetes Service (Part 2)</a></li><li class="chapter-item expanded "><a href="../cloud-native/test-service-performance-1.html"><strong aria-hidden="true">1.17.</strong> iperf3 tests the four-layer performance of Kubernetes Service (Part 1)</a></li><li class="chapter-item expanded "><a href="../cloud-native/k8s-cmd.html"><strong aria-hidden="true">1.18.</strong> k8s common command</a></li><li class="chapter-item expanded "><a href="../cloud-native/cpu-binding.html"><strong aria-hidden="true">1.19.</strong> k8s supports container core binding</a></li><li class="chapter-item expanded "><a href="../cloud-native/capability.html"><strong aria-hidden="true">1.20.</strong> k8s supports Capability mechanism</a></li><li class="chapter-item expanded "><a href="../cloud-native/oom.html"><strong aria-hidden="true">1.21.</strong> k8s OOMkilled container exceeding memory limit</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">2.</strong> Catalog: Openstack</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../openstack/deploy-openstack-stein.html"><strong aria-hidden="true">2.1.</strong> Problems encountered in Openstack Stein deployment</a></li><li class="chapter-item expanded "><a href="../openstack/sriov2ovs.html"><strong aria-hidden="true">2.2.</strong> sriov computing node to ovs computing node script</a></li><li class="chapter-item expanded "><a href="../openstack/placement.html"><strong aria-hidden="true">2.3.</strong> Openstack Placement</a></li><li class="chapter-item expanded "><a href="../openstack/power-arch.html"><strong aria-hidden="true">2.4.</strong> POWER architecture server as computing node</a></li><li class="chapter-item expanded "><a href="../openstack/sriov.html"><strong aria-hidden="true">2.5.</strong> OpenStack practices SR-IOV computing nodes</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-4.html"><strong aria-hidden="true">2.6.</strong> Openstack operation and maintenance records (4)</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-3.html"><strong aria-hidden="true">2.7.</strong> Openstack operation and maintenance records (3)</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-2.html"><strong aria-hidden="true">2.8.</strong> Openstack operation and maintenance records (2)</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-op-1.html"><strong aria-hidden="true">2.9.</strong> Openstack operation and maintenance records (1)</a></li><li class="chapter-item expanded "><a href="../openstack/novnc-problem.html"><strong aria-hidden="true">2.10.</strong> OpenStack Pike dashboard noVNC cannot be accessed problem</a></li><li class="chapter-item expanded "><a href="../openstack/openstack-local-yum.html"><strong aria-hidden="true">2.11.</strong> Openstack Pike local yum source construction</a></li><li class="chapter-item expanded "><a href="../openstack/cpu-binding.html"><strong aria-hidden="true">2.12.</strong> CPU binding</a></li><li class="chapter-item expanded "><a href="../openstack/resize-fail.html"><strong aria-hidden="true">2.13.</strong> Investigation of the cause of resize failure</a></li><li class="chapter-item expanded "><a href="../openstack/mount-cloud-disk.html"><strong aria-hidden="true">2.14.</strong> Mount cloud disk</a></li><li class="chapter-item expanded "><a href="../openstack/ocata-nova-evacuate-bug.html"><strong aria-hidden="true">2.15.</strong> Ocata nova evacuate bug</a></li><li class="chapter-item expanded "><a href="../openstack/compute-node-ha.html"><strong aria-hidden="true">2.16.</strong> compute node ha mainstream open source implementation</a></li><li class="chapter-item expanded "><a href="../openstack/collectd-influxdb.html"><strong aria-hidden="true">2.17.</strong> Deployment and usage of Collectd and InfluxDB</a></li><li class="chapter-item expanded "><a href="../openstack/live-migration-local.html"><strong aria-hidden="true">2.18.</strong> Live Migration on Local Storage</a></li><li class="chapter-item expanded "><a href="../openstack/fast-evacuation.html"><strong aria-hidden="true">2.19.</strong> Add fast evacuation function to VM HA procedure</a></li><li class="chapter-item expanded "><a href="../openstack/vm-activation-failure.html"><strong aria-hidden="true">2.20.</strong> Windows virtual machine activation failure problem</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">3.</strong> Catalog: Point of view</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../point-of-view/huawei-and-operators.html"><strong aria-hidden="true">3.1.</strong> Huawei and telecom operators</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">4.</strong> Open source small project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../open-source-small-project/firewall-tool.html"><strong aria-hidden="true">4.1.</strong> Open source a node.js firewall tool</a></li></ol></li><li class="chapter-item expanded "><a href="../SUMMARY.html"><strong aria-hidden="true">5.</strong> Catalog: Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tools/github-action.html"><strong aria-hidden="true">5.1.</strong> Github Action Supplementary Introduction</a></li><li class="chapter-item expanded "><a href="../tools/blog-cicd.html"><strong aria-hidden="true">5.2.</strong> Github Action Upgrade backend cloud website CICD process</a></li><li class="chapter-item expanded "><a href="../tools/github-action-demo.html"><strong aria-hidden="true">5.3.</strong> Try the Github Action CI/CD process (create a React project and package it for deployment)</a></li><li class="chapter-item expanded "><a href="../tools/notion-widget.html"><strong aria-hidden="true">5.4.</strong> Notion's page insert widget Widget</a></li><li class="chapter-item expanded "><a href="../tools/git-dir.html"><strong aria-hidden="true">5.5.</strong> Internal structure of .git directory</a></li><li class="chapter-item expanded "><a href="../tools/xshell-skill.html"><strong aria-hidden="true">5.6.</strong> Some Skills of using xshell tools</a></li><li class="chapter-item expanded "><a href="../tools/gerrit-install.html"><strong aria-hidden="true">5.7.</strong> gerrit install</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">English version of the website https://www.backendcloud.cn/</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <p>release time :2022-09-01 18:14</p>
<p>Because of the low performance of netfilter of iptables, the kube-proxy component of Kubernetes has been criticized all the time. Both Cilium and Calico fully realize the functions of kube-proxy, including ClusterIP, NodePort, ExternalIPs and LoadBalancer, which can completely replace its position and provide better performance.</p>
<p>Both Cilium and Calico support replacing the kube-proxy component of Kubernetes. This article introduces the replacement of kube-proxy by Cilium.</p>
<h1 id="start-a-2-node-kubernetes-cluster"><a class="header" href="#start-a-2-node-kubernetes-cluster">Start a 2-node Kubernetes cluster</a></h1>
<pre><code>[dev@centos9 ~]$ minikube start --vm-driver=podman --network-plugin=cni --nodes=2
* minikube v1.26.1 on Centos 9
* Using the podman driver based on user configuration
! With --network-plugin=cni, you will need to provide your own CNI. See --cni flag as a user-friendly alternative
* Using Podman driver with root privileges
* Starting control plane node minikube in cluster minikube
* Pulling base image ...
E0901 13:47:15.274484 1303088 cache.go:203] Error downloading kic artifacts:  not yet implemented, see issue #8426
* Creating podman container (CPUs=2, Memory=4000MB) ...
* Preparing Kubernetes v1.24.3 on Docker 20.10.17 ...
- Generating certificates and keys ...
- Booting up control plane ...
- Configuring RBAC rules ...
* Configuring CNI (Container Networking Interface) ...
* Verifying Kubernetes components...
- Using image gcr.io/k8s-minikube/storage-provisioner:v5
* Enabled addons: storage-provisioner, default-storageclass

* Starting worker node minikube-m02 in cluster minikube
* Pulling base image ...
E0901 13:47:42.095257 1303088 cache.go:203] Error downloading kic artifacts:  not yet implemented, see issue #8426
* Creating podman container (CPUs=2, Memory=4000MB) ...
* Found network options:
- NO_PROXY=192.168.49.2
* Preparing Kubernetes v1.24.3 on Docker 20.10.17 ...
- env NO_PROXY=192.168.49.2
* Verifying Kubernetes components...
* Done! kubectl is now configured to use &quot;minikube&quot; cluster and &quot;default&quot; namespace by default
[dev@centos9 ~]$ kubectl get nodes -o wide
NAME           STATUS   ROLES           AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION          CONTAINER-RUNTIME
minikube       Ready    control-plane   66s   v1.24.3   192.168.49.2   &lt;none&gt;        Ubuntu 20.04.4 LTS   5.14.0-115.el9.x86_64   docker://20.10.17
minikube-m02   Ready    &lt;none&gt;          37s   v1.24.3   192.168.49.3   &lt;none&gt;        Ubuntu 20.04.4 LTS   5.14.0-115.el9.x86_64   docker://20.10.17
[dev@centos9 ~]$ kubectl get pod -A
NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
kube-system   coredns-6d4b75cb6d-9trth           1/1     Running   0          96s
kube-system   etcd-minikube                      1/1     Running   0          109s
kube-system   kindnet-lt7zb                      1/1     Running   0          83s
kube-system   kindnet-w8wb5                      1/1     Running   0          96s
kube-system   kube-apiserver-minikube            1/1     Running   0          109s
kube-system   kube-controller-manager-minikube   1/1     Running   0          109s
kube-system   kube-proxy-crrhc                   1/1     Running   0          83s
kube-system   kube-proxy-gzf5l                   1/1     Running   0          96s
kube-system   kube-scheduler-minikube            1/1     Running   0          109s
kube-system   storage-provisioner                1/1     Running   0          107s
</code></pre>
<h1 id="delete-the-kube-proxy-component"><a class="header" href="#delete-the-kube-proxy-component">Delete the kube-proxy component</a></h1>
<pre><code>[dev@centos9 ~]$ kubectl -n kube-system delete ds kube-proxy
daemonset.apps &quot;kube-proxy&quot; deleted
[dev@centos9 ~]$ kubectl get cm -A
NAMESPACE         NAME                                 DATA   AGE
default           kube-root-ca.crt                     1      111s
kube-node-lease   kube-root-ca.crt                     1      111s
kube-public       cluster-info                         3      2m4s
kube-public       kube-root-ca.crt                     1      111s
kube-system       coredns                              1      2m4s
kube-system       extension-apiserver-authentication   6      2m7s
kube-system       kube-proxy                           2      2m4s
kube-system       kube-root-ca.crt                     1      111s
kube-system       kubeadm-config                       1      2m6s
kube-system       kubelet-config                       1      2m6s
[dev@centos9 ~]$ kubectl -n kube-system delete cm kube-proxy
configmap &quot;kube-proxy&quot; deleted
[dev@centos9 ~]$ kubectl get pod -A
NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
kube-system   coredns-6d4b75cb6d-9trth           1/1     Running   0          2m4s
kube-system   etcd-minikube                      1/1     Running   0          2m17s
kube-system   kindnet-lt7zb                      1/1     Running   0          111s
kube-system   kindnet-w8wb5                      1/1     Running   0          2m4s
kube-system   kube-apiserver-minikube            1/1     Running   0          2m17s
kube-system   kube-controller-manager-minikube   1/1     Running   0          2m17s
kube-system   kube-scheduler-minikube            1/1     Running   0          2m17s
kube-system   storage-provisioner                1/1     Running   0          2m15s
</code></pre>
<h1 id="cilium-install"><a class="header" href="#cilium-install">Cilium install</a></h1>
<pre><code>[dev@centos9 ~]$ helm repo add cilium https://helm.cilium.io/
&quot;cilium&quot; already exists with the same configuration, skipping
[dev@centos9 ~]$ helm install cilium cilium/cilium --version 1.9.18 \
    --namespace kube-system \
    --set kubeProxyReplacement=strict \
    --set k8sServiceHost=192.168.49.2 \
    --set k8sServicePort=8443
W0901 13:52:40.725154 1314269 warnings.go:70] spec.template.metadata.annotations[scheduler.alpha.kubernetes.io/critical-pod]: non-functional in v1.16+; use the &quot;priorityClassName&quot; field instead
NAME: cilium
LAST DEPLOYED: Thu Sep  1 13:52:40 2022
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble.

Your release version is 1.9.18.

For any further help, visit https://docs.cilium.io/en/v1.9/gettinghelp
[dev@centos9 ~]$ kubectl get pod -A
NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
kube-system   cilium-822s8                       1/1     Running   0          3m41s
kube-system   cilium-operator-7c58cbbc4c-c9plf   1/1     Running   0          3m41s
kube-system   cilium-operator-7c58cbbc4c-fbzft   1/1     Running   0          3m41s
kube-system   cilium-rk8c7                       1/1     Running   0          3m41s
kube-system   coredns-6d4b75cb6d-9trth           1/1     Running   0          8m28s
kube-system   etcd-minikube                      1/1     Running   0          8m41s
kube-system   kindnet-lt7zb                      1/1     Running   0          8m15s
kube-system   kindnet-w8wb5                      1/1     Running   0          8m28s
kube-system   kube-apiserver-minikube            1/1     Running   0          8m41s
kube-system   kube-controller-manager-minikube   1/1     Running   0          8m41s
kube-system   kube-scheduler-minikube            1/1     Running   0          8m41s
kube-system   storage-provisioner                1/1     Running   0          8m39s
</code></pre>
<h1 id="verify-that-cilium-has-completely-replaced-kube-proxy"><a class="header" href="#verify-that-cilium-has-completely-replaced-kube-proxy">Verify that Cilium has completely replaced kube-proxy</a></h1>
<h2 id="enter-the-cilium-container-to-view-the-details-of-the-cilium-status"><a class="header" href="#enter-the-cilium-container-to-view-the-details-of-the-cilium-status">Enter the cilium container to view the details of the cilium status</a></h2>
<pre><code>[dev@centos9 ~]$ kubectl exec -it -n kube-system cilium-822s8 -- cilium status | grep KubeProxyReplacement
Defaulted container &quot;cilium-agent&quot; out of: cilium-agent, mount-cgroup (init), clean-cilium-state (init)
KubeProxyReplacement:   Strict   [eth0 (Direct Routing)]
[dev@centos9 ~]$ kubectl exec -it -n kube-system cilium-822s8 -- cilium status --verbose
Defaulted container &quot;cilium-agent&quot; out of: cilium-agent, mount-cgroup (init), clean-cilium-state (init)
KVStore:                Ok   Disabled
Kubernetes:             Ok   1.24 (v1.24.3) [linux/amd64]
Kubernetes APIs:        [&quot;cilium/v2::CiliumClusterwideNetworkPolicy&quot;, &quot;cilium/v2::CiliumEndpoint&quot;, &quot;cilium/v2::CiliumNetworkPolicy&quot;, &quot;cilium/v2::CiliumNode&quot;, &quot;core/v1::Namespace&quot;, &quot;core/v1::Node&quot;, &quot;core/v1::Pods&quot;, &quot;core/v1::Service&quot;, &quot;discovery/v1beta1::EndpointSlice&quot;, &quot;networking.k8s.io/v1::NetworkPolicy&quot;]
KubeProxyReplacement:   Strict   [eth0 (Direct Routing)]
Cilium:                 Ok   1.9.18 (v1.9.18-5f79f26)
NodeMonitor:            Listening for events on 128 CPUs with 64x4096 of shared memory
Cilium health daemon:   Ok   
IPAM:                   IPv4: 2/255 allocated from 10.0.0.0/24, 
Allocated addresses:
10.0.0.180 (router)
10.0.0.196 (health)
BandwidthManager:       Disabled
Host Routing:           BPF
Masquerading:           BPF       [eth0]   10.0.0.0/24
Clock Source for BPF:   jiffies   [1000 Hz]
Controller Status:      17/17 healthy
Name                                  Last success   Last error   Count   Message
cilium-health-ep                      19s ago        never        0       no error   
dns-garbage-collector-job             37s ago        never        0       no error   
endpoint-3305-regeneration-recovery   never          never        0       no error   
endpoint-979-regeneration-recovery    never          never        0       no error   
k8s-heartbeat                         7s ago         never        0       no error   
metricsmap-bpf-prom-sync              2s ago         never        0       no error   
neighbor-table-refresh                3m20s ago      never        0       no error   
resolve-identity-3305                 3m19s ago      never        0       no error   
resolve-identity-979                  3m20s ago      never        0       no error   
sync-endpoints-and-host-ips           20s ago        never        0       no error   
sync-lb-maps-with-k8s-services        3m20s ago      never        0       no error   
sync-policymap-3305                   18s ago        never        0       no error   
sync-policymap-979                    18s ago        never        0       no error   
sync-to-k8s-ciliumendpoint (3305)     9s ago         never        0       no error   
sync-to-k8s-ciliumendpoint (979)      0s ago         never        0       no error   
template-dir-watcher                  never          never        0       no error   
update-k8s-node-annotations           3m25s ago      never        0       no error   
Proxy Status:   OK, ip 10.0.0.180, 0 redirects active on ports 10000-20000
Hubble:         Ok   Current/Max Flows: 84/4096 (2.05%), Flows/s: 0.42   Metrics: Disabled
KubeProxyReplacement Details:
Status:              Strict
Protocols:           TCP, UDP
Devices:             eth0 (Direct Routing)
Mode:                SNAT
Backend Selection:   Random
Session Affinity:    Enabled
XDP Acceleration:    Disabled
Services:
- ClusterIP:      Enabled
- NodePort:       Enabled (Range: 30000-32767) 
- LoadBalancer:   Enabled 
- externalIPs:    Enabled 
- HostPort:       Enabled
BPF Maps:   dynamic sizing: on (ratio: 0.002500)
Name                          Size
Non-TCP connection tracking   147475
TCP connection tracking       294951
Endpoint policy               65535
Events                        128
IP cache                      512000
IP masquerading agent         16384
IPv4 fragmentation            8192
IPv4 service                  65536
IPv6 service                  65536
IPv4 service backend          65536
IPv6 service backend          65536
IPv4 service reverse NAT      65536
IPv6 service reverse NAT      65536
Metrics                       1024
NAT                           294951
Neighbor table                294951
Global policy                 16384
Per endpoint policy           65536
Session affinity              65536
Signal                        128
Sockmap                       65535
Sock reverse NAT              147475
Tunnel                        65536
Cluster health:              1/2 reachable   (2022-09-01T05:56:12Z)
Name                       IP              Node        Endpoints
minikube-m02 (localhost)   192.168.49.3    reachable   reachable
minikube                   192.168.49.2    reachable   unreachable
</code></pre>
<blockquote>
<p>Services:</p>
<ul>
<li>ClusterIP: Enabled</li>
<li>NodePort: Enabled (Range: 30000-32767)</li>
<li>LoadBalancer: Enabled</li>
<li>externalIPs: Enabled</li>
<li>HostPort: Enabled
Because kube-proxy has been deleted, Cilium has enabled the ClusterIP, NodePort, HostPort, ExternalIPs and LoadBalancer functions of kube-proxy. Implemented Cilium's complete replacement of kube-proxy.</li>
</ul>
</blockquote>
<h2 id="start-nginx-deployment-and-service-verify-cilium-service-list-information-and-nginx-service"><a class="header" href="#start-nginx-deployment-and-service-verify-cilium-service-list-information-and-nginx-service">Start nginx deployment and service, verify cilium service list information and nginx service</a></h2>
<pre><code>[dev@centos9 ~]$ cd tt
[dev@centos9 tt]$ cat nginx.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
name: my-nginx
spec:
selector:
    matchLabels:
    run: my-nginx
replicas: 2
template:
    metadata:
    labels:
        run: my-nginx
    spec:
    containers:
    - name: my-nginx
        image: nginx
        ports:
        - containerPort: 80
[dev@centos9 tt]$ kubectl create -f nginx.yaml 
deployment.apps/my-nginx created
[dev@centos9 tt]$ kubectl get pod -o wide
NAME                       READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
my-nginx-df7bbf6f5-48phr   1/1     Running   0          55s   10.244.0.3   minikube       &lt;none&gt;           &lt;none&gt;
my-nginx-df7bbf6f5-5clvf   1/1     Running   0          55s   10.244.1.2   minikube-m02   &lt;none&gt;           &lt;none&gt;
[dev@centos9 tt]$ kubectl get pods -l run=my-nginx -o wide
NAME                       READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
my-nginx-df7bbf6f5-48phr   1/1     Running   0          66s   10.244.0.3   minikube       &lt;none&gt;           &lt;none&gt;
my-nginx-df7bbf6f5-5clvf   1/1     Running   0          66s   10.244.1.2   minikube-m02   &lt;none&gt;           &lt;none&gt;
[dev@centos9 tt]$ kubectl expose deployment my-nginx --type=NodePort --port=80
service/my-nginx exposed
[dev@centos9 tt]$ kubectl get svc my-nginx
NAME       TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE
my-nginx   NodePort   10.99.99.54   &lt;none&gt;        80:31683/TCP   8s
[dev@centos9 tt]$ kubectl exec -it -n kube-system cilium-822s8 -- cilium service list
Defaulted container &quot;cilium-agent&quot; out of: cilium-agent, mount-cgroup (init), clean-cilium-state (init)
ID   Frontend             Service Type   Backend                  
1    10.96.0.1:443        ClusterIP      1 =&gt; 192.168.49.2:8443   
2    10.96.0.10:53        ClusterIP      1 =&gt; 10.244.0.2:53       
3    10.96.0.10:9153      ClusterIP      1 =&gt; 10.244.0.2:9153     
4    10.99.99.54:80       ClusterIP      1 =&gt; 10.244.1.2:80       
                                        2 =&gt; 10.244.0.3:80       
5    192.168.49.3:31683   NodePort       1 =&gt; 10.244.1.2:80       
                                        2 =&gt; 10.244.0.3:80       
6    0.0.0.0:31683        NodePort       1 =&gt; 10.244.1.2:80       
                                        2 =&gt; 10.244.0.3:80       
[dev@centos9 tt]$ minikube ssh
docker@minikube:~$ curl 192.168.49.2:31683
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
# 访问第二个节点的 nodeport，可以访问
docker@minikube:~$ curl 192.168.49.3:31683
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../cloud-native/k8s-service.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../cloud-native/cilium-install.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../cloud-native/k8s-service.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../cloud-native/cilium-install.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../sidebar.js"></script>


    </body>
</html>