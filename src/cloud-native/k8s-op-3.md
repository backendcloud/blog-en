release time :2022-11-30 18:56


# Kubernetes certificates renewed for 100 years
Question: A customer requests to renew the certificate for 100 years, but actually, it can only be renewed for 10 years

Reason: CA certificate is only valid for 10 years.

Countermeasure: Modify the Kubernetes code, there are 2 modifications.

The first modified code is located in the Kubernetes project's

\staging\src\k8s.io\client-go\util\cert\cert.go 60 lines

    tmpl := x509.Certificate{
            SerialNumber: new(big.Int).SetInt64(0),
            Subject: pkix.Name{
                CommonName:   cfg.CommonName,
                Organization: cfg.Organization,
            },
            DNSNames:              []string{cfg.CommonName},
            NotBefore:             now.UTC(),
            NotAfter:              now.Add(duration365d * 10).UTC(),
            KeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature | x509.KeyUsageCertSign,
            BasicConstraintsValid: true,
            IsCA:                  true,
        }


Change now.Add(duration365d * 10).UTC(), to now.Add(duration365d * 10 * 10).UTC(),

The code for the second modification is located in the Kubernetes project

kubernetes\cmd\kubeadm\app\constants\constants.go line 48

    // CertificateValidity defines the validity for all the signed certificates generated by kubeadm
    CertificateValidity = time.Hour * 24 * 365


Change time.Hour * 24 * 365 to time.Hour * 24 * 365 * 100

Enter the root directory of the kubernete project and execute

    make all WHAT=cmd/kubeadm GOFLAGS=-v

Compiled product: the executable file kubeadm is located in the _output/bin/kubeadm directory

> refer to: https://kubernetes.io/zh-cn/docs/tasks/tls/

# Filestore experiences intermittent read and write failures
Unable to read and write files, even ssh cannot log in, no session is generated after login. Only console login. At this time, consider whether the disk is full.

If df -h finds that there is still enough free space on the disk, check whether the inode is full due to too many small files. df -i command to view.

    df -i

    Filesystem                    Inodes   IUsed  IFree IUse% Mounted on
    /dev/mapper/dev01-root       4964352 4964352      0  100% /
    udev                          503779     440 503339    1% /dev
    tmpfs                         506183     353 505830    1% /run
    none                          506183       5 506178    1% /run/lock
    none                          506183       2 506181    1% /run/shm
    /dev/sda1                     124496     255 124241    1% /boot

There are two ways to solve the 100% inodes occupation, one is to delete useless files, and the other is to expand the capacity.

Check the number of files in the tmp directory ls -lt /tmp | wc -l

If there are too many files in the tmp directory, delete the files in the tmp directory find /tmp -type f -exec rm {} ;

If deletion does not solve the problem, consider expanding the capacity. ext4 file format does not support inode expansion, xfs file format supports inode expansion

The ext4 file format supports configuring the inode parameters to adjust the inode space size when formatting the partition, but it is better to directly set the disk to the expandable xfs format.

    [root@dqysh020073 app]# xfs_info /app
    meta-data=/dev/mapper/VolGroup-app isize=512    agcount=4, agsize=773888 blks
            =                       sectsz=512   attr=2, projid32bit=1
            =                       crc=1        finobt=0 spinodes=0
    data     =                       bsize=4096   blocks=3095552, imaxpct=1
            =                       sunit=0      swidth=0 blks
    naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
    log      =internal               bsize=4096   blocks=2560, version=2
            =                       sectsz=512   sunit=0 blks, lazy-count=1
    realtime =none                   extsz=4096   blocks=0, rtextents=0

isize=512 means the default size of the inode is 512 bytes, imaxpct=1 means the maximum space of the inode is 1%, and the inode can be expanded by the command xfs_growfs -m 2 /app.

After expansion, use the df -i command to verify the inode information.


