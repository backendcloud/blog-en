release time :2017-05-04 22:21


# question survey

## direct cause

After investigation, we found that due to the cloud environment, There is a deviation between the time of the windows virtual machine and the time of the physical machine, which causes the activation to fail.

## Specific time deviation

Windows instance sometimes finds that the operating system time is always 8 hours behind. Even if the time and time zone are manually adjusted, the difference will be 8 hours after the next restart of the instance.

## Why is there a time deviation?

KVM handles system time differently for Linux and Windows virtual machines, and Windows requires some additional settings.

Why do Linux and Windows virtual machines handle system time differently? To understand the following three concepts.

###UTC time and local time

UTC time: Also known as the world standard time and the unified world time, UTC is calibrated by atomic clocks, and other parts of the world use this as the reference time plus their own time zone to set their local time

Local time: Due to different time zones, local time is generally different from UTC, and the conversion method is

Local time = UTC + time zone or UTC = local time - time

zone The east of the time zone is positive, and the west is negative. In China, the time zone is the east eighth district, which is +8 district. The local time uses Beijing time, which is displayed on linux as CST , so CST=UTC+(+8 hours) or UTC=CST-(+8 hours)

### guest OS time keeping

The kvm technology is fully virtualized, and the guest OS can run directly without modification. However, there are problems in timing. One way of guest OS timing is to count through clock interrupts and then convert them, but the clock interrupts generated by the host Can't reach all guest OS in time, because interrupt in guest OS is not really hardware interrupt, it's interrupt injected by host

Many network applications, session verification in the web, etc., will call the system time. If the time in the guest OS is wrong, it will cause a program error. For this reason, kvm provides a paravirtualized clock (kvm-clock) for the guest vms. In RHEL5.5 and above, kvm-clock is used as the default clock source, you can use the following command in the guest to check whether kvm-clock is used

    cat /sys/devices/system/clocksource/clocksource0/current_clocksource
    kvm-clock

In the kvm-clock mode, the guest OS cannot directly access the host clock, and the host writes the system time into a memory page that the guest can read, so that the guest can read this memory page to set its own hardware time, but the host does not update it in real time The time is up to this memory page, but it is updated when a vm event (vm shutdown, restart, etc.) occurs, so this method cannot keep the guest time accurate

### Set the virtual machine hardware clock in libvirt

The kvm virtual machine is generally managed by libvirt. In the xml file of the virtual machine configuration, there are items related to the hardware clock setting of the virtual machine.

    <clock offset='localtime'>
    </clock>

The offset attribute of the clock has four options: "utc", "localtime", "timezone", and "variable".

If the guest OS is a Linux system, "utc" should be selected. The guest OS will synchronize the utc time with the host once when it starts, and then calculate the system time according to the time zone set in /etc/localtime

If the guest OS is a windows system, "localtime" should be selected, and the guest OS will synchronize the system time with the host once at startup

# Countermeasures in the openstack cloud environment

## For new windows virtual machines

It is to add os_type="windows" information to the existing windows image and the new windows image created in the future

    [root@build localhost]# glance image-update  --property os_type="windows" 1d2afd0f-9162-415c-ace3-97de254b6c9c
    1d2afd0f-9162-415c-ace3-97de254b6c9c 是vm id

## For existing windows virtual machines

To modify the database through violence, the specific plan:
1. Find out the uuid information of all the existing windows virtual machines to be modified
2. Enter the nova database, modify the os_type field of the windows virtual machine in the instances table, and modify the field For windows, for example, modify the os_type field of the vm whose vm id is f64bf83d-a9f0-4ec5-b481-e3e76e19b6bd to windows
3. update instances set os_type='windows' where uuid='f64bf83d-a9f0-4ec5-b481-e363de19bd' Check whether the os_type field is changed to 'windows', for example, select * from instances where uuid='f64bf83d-a9f0-4ec5-b481-e3e76e19b6bd';
4. Hard restart the virtual machine, you need to contact the customer in advance
`# nova reboot f64bf83d-a9f0-4ec5 -b481-e3e76e19b6bd –hard –poll`
restart Reason: KVM will obtain the modified database information, update the XML configuration, and ensure time synchronization.

# Test: Whether the vm generated by nova boot will have the keyword of image

    [root@NFJD-TESTVM-CORE-API-1 ~]# glance image-update --property os_type="windows" fb5bc637-c8ab-4999-9e88-da28561fed21
    +---------------------+--------------------------------------------------+
    | Property | Value |
    +---------------------+--------------------------------------------------+
    | checksum | 8049db08971bec254be86067025d0c32 |
    | container_format | bare |
    | created_at | 2016-07-12T06:16:50Z |
    | direct_url | sheepdog://fb5bc637-c8ab-4999-9e88-da28561fed21 |
    | disk_format | qcow2 |
    | hw_qemu_guest_agent | yes |
    | id | fb5bc637-c8ab-4999-9e88-da28561fed21 |
    | image.os_type | windows |
    | min_disk | 0 |
    | min_ram | 0 |
    | name | Windows-Server-2008-R2-Enterprise-64bit-20160706 |
    | os_distro | windows |
    | os_type | windows |
    | owner | 6c149dcd3cf64171b8dd972dd03bbac0 |
    | protected | False |
    | size | 10015539200 |
    | status | active |
    | tags | [] |
    | updated_at | 2017-05-05T03:42:50Z |
    | virtual_size | None |
    | visibility | public |
    +---------------------+--------------------------------------------------+
    [root@NFJD-TESTVM-CORE-API-1 ~]# nova image-show fb5bc637-c8ab-4999-9e88-da28561fed21
    +------------------------------+--------------------------------------------------+
    | Property | Value |
    +------------------------------+--------------------------------------------------+
    | OS-EXT-IMG-SIZE:size | 10015539200 |
    | created | 2016-07-12T06:16:50Z |
    | id | fb5bc637-c8ab-4999-9e88-da28561fed21 |
    | metadata hw_qemu_guest_agent | yes |
    | metadata image.os_type | windows |
    | metadata os_distro | windows |
    | metadata os_type | windows |
    | minDisk | 0 |
    | minRam | 0 |
    | name | Windows-Server-2008-R2-Enterprise-64bit-20160706 |
    | progress | 100 |
    | status | ACTIVE |
    | updated | 2017-05-05T03:42:50Z |
    +------------------------------+--------------------------------------------------+
    [root@NFJD-TESTVM-CORE-API-1 ~]# nova boot --image fb5bc637-c8ab-4999-9e88-da28561fed21 --flavor 3 --nic net-id=ee98ec6a-e1ed-43eb-9d0a-26080d277484 t4 --availability-zone nova:NFJD-TESTN-COMPUTE-3
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    | Property | Value |
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    | OS-DCF:diskConfig | MANUAL |
    | OS-EXT-AZ:availability_zone | nova |
    | OS-EXT-SRV-ATTR:host | - |
    | OS-EXT-SRV-ATTR:hypervisor_hostname | - |
    | OS-EXT-SRV-ATTR:instance_name | instance-000056dc |
    | OS-EXT-STS:power_state | 0 |
    | OS-EXT-STS:task_state | scheduling |
    | OS-EXT-STS:vm_state | building |
    | OS-SRV-USG:launched_at | - |
    | OS-SRV-USG:terminated_at | - |
    | accessIPv4 | |
    | accessIPv6 | |
    | adminPass | DoLL3d65w7cN |
    | config_drive | |
    | created | 2017-05-05T03:46:42Z |
    | flavor | m1.medium (3) |
    | hostId | |
    | id | f64bf83d-a9f0-4ec5-b481-e3e76e19b6bd |
    | image | Windows-Server-2008-R2-Enterprise-64bit-20160706 (fb5bc637-c8ab-4999-9e88-da28561fed21) |
    | key_name | - |
    | metadata | {} |
    | name | t4 |
    | os-extended-volumes:volumes_attached | [] |
    | progress | 0 |
    | security_groups | default |
    | status | BUILD |
    | tenant_id | 6c149dcd3cf64171b8dd972dd03bbac0 |
    | updated | 2017-05-05T03:46:43Z |
    | user_id | 62f52135115f4898bd0d82c1f0cd632b |
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    [root@NFJD-TESTVM-CORE-API-1 ~]# nova show t4
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    | Property | Value |
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    | OS-DCF:diskConfig | MANUAL |
    | OS-EXT-AZ:availability_zone | nova |
    | OS-EXT-SRV-ATTR:host | NFJD-TESTN-COMPUTE-3 |
    | OS-EXT-SRV-ATTR:hypervisor_hostname | NFJD-TESTN-COMPUTE-3 |
    | OS-EXT-SRV-ATTR:instance_name | instance-000056dc |
    | OS-EXT-STS:power_state | 1 |
    | OS-EXT-STS:task_state | - |
    | OS-EXT-STS:vm_state | active |
    | OS-SRV-USG:launched_at | 2017-05-05T03:46:50.000000 |
    | OS-SRV-USG:terminated_at | - |
    | accessIPv4 | |
    | accessIPv6 | |
    | config_drive | True |
    | created | 2017-05-05T03:46:42Z |
    | flavor | m1.medium (3) |
    | hostId | c34578f3d9c097be0d91fda237706199673ca7e5a87051f5aad24637 |
    | id | f64bf83d-a9f0-4ec5-b481-e3e76e19b6bd |
    | image | Windows-Server-2008-R2-Enterprise-64bit-20160706 (fb5bc637-c8ab-4999-9e88-da28561fed21) |
    | key_name | - |
    | metadata | {} |
    | name | t4 |
    | net001 network | 192.168.2.92 |
    | os-extended-volumes:volumes_attached | [] |
    | progress | 0 |
    | security_groups | default |
    | status | ACTIVE |
    | tenant_id | 6c149dcd3cf64171b8dd972dd03bbac0 |
    | updated | 2017-05-05T03:46:51Z |
    | user_id | 62f52135115f4898bd0d82c1f0cd632b |
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    MySQL [nova]> select * from instances where uuid='f64bf83d-a9f0-4ec5-b481-e3e76e19b6bd';
    +---------------------+---------------------+------------+-------+-------------+----------------------------------+----------------------------------+--------------------------------------+-----------+------------+--------------+----------+----------+-------------+----------+-----------+-------+----------+----------------------+-----------+----------------+--------------+---------------------+---------------+--------------+---------------------+-------------------+--------+---------+----------------------+------------------+---------+--------------------------------------+--------------+------------------+--------------+--------------+--------------+------------+--------------------------+---------------------+----------+------------------+--------------------+-------------------+---------+--------------+-----------+----------------------+---------+-----------+---------+--------------------+
    | created_at | updated_at | deleted_at | id | internal_id | user_id | project_id | image_ref | kernel_id | ramdisk_id | launch_index | key_name | key_data | power_state | vm_state | memory_mb | vcpus | hostname | host | user_data | reservation_id | scheduled_at | launched_at | terminated_at | display_name | display_description | availability_zone | locked | os_type | launched_on | instance_type_id | vm_mode | uuid | architecture | root_device_name | access_ip_v4 | access_ip_v6 | config_drive | task_state | default_ephemeral_device | default_swap_device | progress | auto_disk_config | shutdown_terminate | disable_terminate | root_gb | ephemeral_gb | cell_name | node | deleted | locked_by | cleaned | ephemeral_key_uuid |
    +---------------------+---------------------+------------+-------+-------------+----------------------------------+----------------------------------+--------------------------------------+-----------+------------+--------------+----------+----------+-------------+----------+-----------+-------+----------+----------------------+-----------+----------------+--------------+---------------------+---------------+--------------+---------------------+-------------------+--------+---------+----------------------+------------------+---------+--------------------------------------+--------------+------------------+--------------+--------------+--------------+------------+--------------------------+---------------------+----------+------------------+--------------------+-------------------+---------+--------------+-----------+----------------------+---------+-----------+---------+--------------------+
    | 2017-05-05 03:46:42 | 2017-05-05 03:46:51 | NULL | 22236 | NULL | 62f52135115f4898bd0d82c1f0cd632b | 6c149dcd3cf64171b8dd972dd03bbac0 | fb5bc637-c8ab-4999-9e88-da28561fed21 | | | 0 | NULL | NULL | 1 | active | 4096 | 2 | t4 | NFJD-TESTN-COMPUTE-3 | NULL | r-ae2dhvll | NULL | 2017-05-05 03:46:50 | NULL | t4 | t4 | nova | 0 | windows | NFJD-TESTN-COMPUTE-3 | 3 | NULL | f64bf83d-a9f0-4ec5-b481-e3e76e19b6bd | NULL | /dev/vda | NULL | NULL | True | NULL | NULL | NULL | 0 | 0 | 0 | 0 | 40 | 0 | NULL | NFJD-TESTN-COMPUTE-3 | 0 | NULL | 0 | NULL |
    +---------------------+---------------------+------------+-------+-------------+----------------------------------+----------------------------------+--------------------------------------+-----------+------------+--------------+----------+----------+-------------+----------+-----------+-------+----------+----------------------+-----------+----------------+--------------+---------------------+---------------+--------------+---------------------+-------------------+--------+---------+----------------------+------------------+---------+--------------------------------------+--------------+------------------+--------------+--------------+--------------+------------+--------------------------+---------------------+----------+------------------+--------------------+-------------------+---------+--------------+-----------+----------------------+---------+-----------+---------+--------------------+
    1 row in set (0.00 sec)

    the instances table of database nova os_type='windows'

# Similarly, for virtual machines that cannot obtain monitoring data, use the following methods to modify the virtual machine configuration:

(1) Contact the colleague who provided the image to confirm that qemu-guest-agent has been installed in the virtual machine

(2) Modify the nova database to change the virtual machine field:

    MariaDB [(none)]> use nova;
    MariaDB [nova]> insert into instance_system_metadata values(NULL,NULL,NULL,NULL,'2cf79497-d1ba-42c3-adf5-3b45c6927dfb','image_hw_qemu_guest_agent','yes',0);
    注： 2cf79497-d1ba-42c3-adf5-3b45c6927dfb 为对应instance的uuid
    检查：select * from instance_system_metadata where instance_uuid='3ce9d8b0-a0a3-48ed-ba54-415883f717e5';

(3) Modify the image used by the virtual machine

    # glance image-update xxx --property hw_qemu_guest_agent=yes --property hw_ovirt_guest_agent=yes

(4) To hard restart the virtual machine, you need to contact the customer in advance

    # nova reboot 2cf79497-d1ba-42c3-adf5-3b45c6927dfb --hard --poll

# Why modifying os_type='windows' will affect the time of windows virtual machine

## openstack will determine the xml content required for the vm of the underlying kvm according to the content of os_type

By querying a windows virtual machine and a linux virtual machine to compare the xml content, it is true that windows vm is clock offset='localtime' linux vm is clock offset='utc'

The <clock> element is used to determine how the guest virtual machine clock is synchronized with the host physical machine clock. The clock element has the following attributes:

offset determines how the guest virtual machine clock is offset from the host physical machine clock.

### windows virtual machine

    [root@NFJD-TESTVM-CORE-API-1 ~]# nova show t4
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    | Property | Value |
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    | OS-DCF:diskConfig | MANUAL |
    | OS-EXT-AZ:availability_zone | nova |
    | OS-EXT-SRV-ATTR:host | NFJD-TESTN-COMPUTE-3 |
    | OS-EXT-SRV-ATTR:hypervisor_hostname | NFJD-TESTN-COMPUTE-3 |
    | OS-EXT-SRV-ATTR:instance_name | instance-000056dc |
    | OS-EXT-STS:power_state | 1 |
    | OS-EXT-STS:task_state | - |
    | OS-EXT-STS:vm_state | active |
    | OS-SRV-USG:launched_at | 2017-05-05T03:46:50.000000 |
    | OS-SRV-USG:terminated_at | - |
    | accessIPv4 | |
    | accessIPv6 | |
    | config_drive | True |
    | created | 2017-05-05T03:46:42Z |
    | flavor | m1.medium (3) |
    | hostId | c34578f3d9c097be0d91fda237706199673ca7e5a87051f5aad24637 |
    | id | f64bf83d-a9f0-4ec5-b481-e3e76e19b6bd |
    | image | Windows-Server-2008-R2-Enterprise-64bit-20160706 (fb5bc637-c8ab-4999-9e88-da28561fed21) |
    | key_name | - |
    | metadata | {} |
    | name | t4 |
    | net001 network | 192.168.2.92 |
    | os-extended-volumes:volumes_attached | [] |
    | progress | 0 |
    | security_groups | default |
    | status | ACTIVE |
    | tenant_id | 6c149dcd3cf64171b8dd972dd03bbac0 |
    | updated | 2017-05-05T03:46:51Z |
    | user_id | 62f52135115f4898bd0d82c1f0cd632b |
    +--------------------------------------+-----------------------------------------------------------------------------------------+
    [root@NFJD-TESTN-COMPUTE-3 ~]# virsh dumpxml instance-000056dc
    ...
    <clock offset='localtime'>
    <timer name='pit' tickpolicy='delay'/>
    <timer name='rtc' tickpolicy='catchup'/>
    <timer name='hpet' present='no'/>
    </clock>
    ...


### linux virtual machine

    [root@NFJD-TESTVM-CORE-API-1 ~]# nova show t1
    +--------------------------------------+-------------------------------------------------------------------+
    | Property | Value |
    +--------------------------------------+-------------------------------------------------------------------+
    | OS-DCF:diskConfig | MANUAL |
    | OS-EXT-AZ:availability_zone | nova |
    | OS-EXT-SRV-ATTR:host | NFJD-TESTN-COMPUTE-1 |
    | OS-EXT-SRV-ATTR:hypervisor_hostname | NFJD-TESTN-COMPUTE-1 |
    | OS-EXT-SRV-ATTR:instance_name | instance-000056d9 |
    | OS-EXT-STS:power_state | 1 |
    | OS-EXT-STS:task_state | - |
    | OS-EXT-STS:vm_state | active |
    | OS-SRV-USG:launched_at | 2017-05-05T02:44:20.000000 |
    | OS-SRV-USG:terminated_at | - |
    | accessIPv4 | |
    | accessIPv6 | |
    | config_drive | True |
    | created | 2017-05-05T02:44:11Z |
    | flavor | m1.medium (3) |
    | hostId | f091880caebe68654030e5df4825e49548af0037454e5723961bfc3d |
    | id | 6316dc6e-2fb0-4d72-8e99-ad5749efc295 |
    | image | CentOS-7.1-x86_64-20161018 (8aaf1759-9fb4-4ba9-8cff-1743eb824c5f) |
    | key_name | - |
    | metadata | {} |
    | name | t1 |
    | net001 network | 192.168.2.90 |
    | os-extended-volumes:volumes_attached | [] |
    | progress | 0 |
    | security_groups | default |
    | status | ACTIVE |
    | tenant_id | 6c149dcd3cf64171b8dd972dd03bbac0 |
    | updated | 2017-05-05T03:36:09Z |
    | user_id | 62f52135115f4898bd0d82c1f0cd632b |
    +--------------------------------------+-------------------------------------------------------------------+
    [root@NFJD-TESTN-COMPUTE-1 ~]# virsh dumpxml instance-000056d9
    ...
    <clock offset='utc'>
    <timer name='pit' tickpolicy='delay'/>
    <timer name='rtc' tickpolicy='catchup'/>
    <timer name='hpet' present='no'/>
    </clock>
    ...

# Related nova code

```python
# nova/virt/libvirt/driver.py

def _set_clock(self, guest, os_type, image_meta, virt_type):
    # NOTE(mikal): Microsoft Windows expects the clock to be in
    # "localtime". If the clock is set to UTC, then you can use a
    # registry key to let windows know, but Microsoft says this is
    # buggy in http://support.microsoft.com/kb/2687252
    clk = vconfig.LibvirtConfigGuestClock()
    if os_type == 'windows':
        LOG.info(_LI('Configuring timezone for windows instance to '
                     'localtime'))
        clk.offset = 'localtime'  # 在os_type为windows的时候clk.offset设置为localtime
    else:
        clk.offset = 'utc'
    guest.set_clock(clk)  # 在os_type为linux的时候clk.offset设置为utc

    if virt_type == "kvm":
        self._set_kvm_timers(clk, os_type, image_meta)
```